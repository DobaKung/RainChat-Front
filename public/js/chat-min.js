"use strict";function scrollToBottom(){$("#chatlog").scrollTop($("#chatlog")[0].scrollHeight)}function connect(o,e){var n=new WebSocket("ws://"+o+":"+e);return console.log(n),n}function addChatLog(o,e){if(e=e.replace(/</g,"&lt;").replace(/>/g,"&gt;"),o.flag){var n,t='<div class="bubble other">'+e+"</div>";if(o.flag&FLAG_MESSAGE)o.id===app.last_id?n="":o.flag&FLAG_FROMPEER?(console.log("is peer"),n=$("<div/>",{"class":"other-name",text:o.username}).prop("outerHTML")):o.flag&FLAG_FROMABOVE?(console.log("is above"),n=$("<div/>",{"class":"other-name",text:o.username+" (public from "+o.roomname+")"}).prop("outerHTML"),n='<div class="other-name">'+o.username+" (public from "+o.roomname+")</div>"):o.flag&FLAG_BOT&&(console.log("is bot"),n=$("<div/>",{"class":"other-name",text:"rainyBot"}).prop("outerHTML"),o.id=-1);else if(o.flag&FLAG_RAIN)return createRain(),console.log("Raining"),app.last_id;console.log("flag: "+o.flag),$("#chatlog").append('<div class="b bub-other-group">'+n+t+"</div>"),$(".b:last-child").visible()&&scrollToBottom(),document.hasFocus()||(notiSound.play(),app.setNotification(app.notification.count+1))}else{if("/"===e.charAt(0)){var i=e.split(" ");e=e.substr(i[0].length),console.log(i),"/public"===i[0]?$("#chatlog").append('<div class="b bubble me">Message public: '+e+"</div>"):"/rain"===i[0]?(createRain(),console.log("Raining")):(console.log("Command not found"),$("<div/>",{"class":"notification-log",text:"Command not found"}).appendTo("#chatlog"))}else $("#chatlog").append('<div class="b bubble me">'+e+"</div>");scrollToBottom()}return o.id}function sendMessage(o){var e=$("#chat").val();if(e){"/exit"===e&&location.reload(),$("#chat").val(""),o.send(e),e=e.replace(/</g,"&lt;").replace(/>/g,"&gt;");addChatLog({id:-1,username:app.username,flag:0},e)}}function ready(o){$("#chatform").submit(function(e){e.preventDefault(),sendMessage(o)}),app.loggedIn=!0,app.typeHere="Type and press enter to send",$("input#chat").focus()}function listen(o,e,n,t){console.log(t);var i=JSON.parse(t);if("message"===i.type)i.roomname=i.roomname.split(".").slice(0,-2),app.last_id=addChatLog(i,i.message);else if("online"===i.type)console.log(i),"added"in i&&i.added!=e&&$("<div/>",{"class":"notification-log",text:i.added+" joined the room"}).appendTo("#chatlog"),"removed"in i&&$("<div/>",{"class":"notification-log",text:i.removed+" left the room"}).appendTo("#chatlog"),app.online=i.users;else if("login"===i.type){if(i.iserror)throw app.loginErrMsg=i.errormsg,i.errormsg;console.log("Logged in!"),ready(o,e,n)}else"rooms"===i.type?console.log(i):console.log("invalid server response")}function login(o,e){var n={username:e};console.log(JSON.stringify(n)),o.send(JSON.stringify(n))}const FLAG_PEER=1,FLAG_PUBLIC=2,FLAG_MESSAGE=4,FLAG_FROMPEER=8,FLAG_FROMABOVE=16,FLAG_RAIN=32,FLAG_ENCRYPT=64,FLAG_BOT=128;var notiSound,app=new Vue({el:"#app",data:{title:"Rainy.Chat",ws:null,login_count:0,loggedIn:!1,loginErrMsg:"",username:"",room:"",drawerOpen:!1,menuOpen:!1,inputBox:"Please log in first",night:!1,nightText:"Night mode",online:[],config:{},notification:{count:0},last_id:-1},methods:{onlineList:function(){var o='{ "type": "online", "count": 0, "users": []}',e=JSON.parse(o);this.online=e.users},checkLogin:function(){this.username?this.username&&(this.login_count++,1===this.login_count?(this.ws=connect(this.config.host,this.config.port),this.ws.onopen=function(){login(app.ws,app.username,"global")},this.ws.onmessage=function(o){listen(app.ws,app.username,app.roomname,o.data)},this.ws.onclose=function(){window.location.reload(!1)},this.inputBox="Type here",setTimeout(function(){$("#chat").focus()},100)):login(this.ws,this.username,"global")):this.loginErrMsg="Please enter a display name"},toggleNight:function(){this.night=!this.night,!1===this.night?(this.nightText="Night mode",$('meta[name="theme-color"]').attr("content","#0267ff"),$("body").css("background-color","#FFF")):(this.nightText="Normal",$('meta[name="theme-color"]').attr("content","#000"),$("body").css("background-color","#000"))},setNotification:function(o){this.notification.count=o;var e;e=o?"("+this.notification.count+") ":"",document.title=e+this.title}}});$(document).ready(function(){notiSound=new Audio("noti.mp3"),$.getJSON("config.json",function(o){app.config=o,console.log(app.config)}),window.onfocus=function(){app.setNotification(0)}}),$("html").click(function(o){"more"!=o.target.id&&(app.menuOpen=!1)});